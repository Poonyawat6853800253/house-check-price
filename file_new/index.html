<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <title>House Price ‚Äî 3 Cards Tester</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body{background:#f7fafc}
    .card.shadow-sm{border-radius:1rem}
    pre{white-space:pre-wrap}
    .kv-row .form-control{min-width:140px}
  </style>
</head>
<body class="p-3 p-md-4">
  <div class="container">
    <header class="mb-4">
      <h1 class="h3 mb-1">‡∏ó‡∏î‡∏™‡∏≠‡∏ö API: ‡∏™‡∏£‡πâ‡∏≤‡∏á 3 ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ö‡πâ‡∏≤‡∏ô</h1>
      <div class="text-muted">‡πÄ‡∏£‡∏µ‡∏¢‡∏Å <code>POST /api/three-cards</code> ‡∏à‡∏≤‡∏Å FastAPI ‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ô‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</div>
    </header>

    <!-- Config -->
    <div class="card shadow-sm mb-3">
      <div class="card-body">
        <div class="row g-2 align-items-end">
          <div class="col-12 col-md-6">
            <label class="form-label">API URL</label>
            <input id="apiUrl" class="form-control" value="http://localhost:5000/api/three-cards">
          </div>
          <div class="col-6 col-md-3">
            <label class="form-label">pct_window</label>
            <input id="pct" type="number" step="0.01" class="form-control" value="0.15">
          </div>
          <div class="col-6 col-md-3">
            <label class="form-label">USD ‚Üí THB</label>
            <input id="rate" type="number" step="0.01" class="form-control" value="36.00">
          </div>
        </div>
      </div>
    </div>

    <!-- Fixed fields builder -->
    <div class="card shadow-sm mb-3">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h2 class="h5 mb-0">Fixed features (‡πÉ‡∏™‡πà‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏≤‡∏Å‡∏•‡πá‡∏≠‡∏Ñ)</h2>
          <div>
            <button id="addRow" class="btn btn-outline-primary btn-sm">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏µ‡∏¢‡πå</button>
            <button id="prefill" class="btn btn-outline-secondary btn-sm ms-2">‡πÄ‡∏ï‡∏¥‡∏°‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á</button>
          </div>
        </div>

        <div id="kvList" class="vstack gap-2">
          <!-- dynamic rows here -->
        </div>

        <div class="mt-3 small text-muted">
          ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ñ‡∏µ‡∏¢‡πå‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ö‡πà‡∏≠‡∏¢: <code>LotArea</code>, <code>OverallQual</code>, <code>GrLivArea</code>, <code>Neighborhood</code> (‡πÉ‡∏™‡πà string ‡πÑ‡∏î‡πâ)
        </div>
      </div>
    </div>

    <!-- Action -->
    <div class="d-flex gap-2 mb-3">
      <button id="go" class="btn btn-success">
        üîÆ Predict 3 Cards
      </button>
      <button id="clear" class="btn btn-outline-secondary">
        ‡∏•‡πâ‡∏≤‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
      </button>
    </div>

    <!-- Output -->
    <div id="status" class="mb-3"></div>
    <div id="cards" class="row g-3"></div>

    <!-- Raw JSON -->
    <div id="rawBox" class="card shadow-sm mt-4 d-none">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h2 class="h6 mb-0">Raw response</h2>
          <button id="toggleRaw" class="btn btn-sm btn-outline-secondary">‡∏ã‡πà‡∏≠‡∏ô</button>
        </div>
        <pre id="raw" class="mb-0 small bg-light p-2 rounded"></pre>
      </div>
    </div>

    <footer class="mt-5 text-center text-muted small">
      ‡∏ñ‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏à‡∏≠ CORS ‡πÉ‡∏´‡πâ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ FastAPI ‡πÄ‡∏õ‡∏¥‡∏î <code>CORS allow_origins=["*"]</code> ‡∏≠‡∏¢‡∏π‡πà (‡πÇ‡∏Ñ‡πâ‡∏î‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡πâ‡πÅ‡∏•‡πâ‡∏ß)
    </footer>
  </div>

  <script>
    // ---------- Helpers ----------
    const $ = (sel) => document.querySelector(sel);
    const fmt = (n) => n?.toLocaleString(undefined, {maximumFractionDigits:2});
    const el = (tag, cls, html) => {
      const d = document.createElement(tag);
      if (cls) d.className = cls;
      if (html !== undefined) d.innerHTML = html;
      return d;
    };

    function rowTemplate(key="", val="") {
      const wrap = el("div","kv-row row g-2 align-items-center");
      wrap.innerHTML = `
        <div class="col-5 col-md-3">
          <input class="form-control kv-key" placeholder="‡πÄ‡∏ä‡πà‡∏ô LotArea" value="${key}">
        </div>
        <div class="col-7 col-md-7">
          <input class="form-control kv-val" placeholder="‡πÄ‡∏ä‡πà‡∏ô 9000 ‡∏´‡∏£‡∏∑‡∏≠ NAmes" value="${val}">
        </div>
        <div class="col-12 col-md-2 text-md-end">
          <button class="btn btn-outline-danger w-100 removeRow">‡∏•‡∏ö</button>
        </div>
      `;
      wrap.querySelector(".removeRow").onclick = () => wrap.remove();
      return wrap;
    }

    function collectFixed() {
      const rows = [...document.querySelectorAll(".kv-row")];
      const fixed = {};
      for (const r of rows) {
        const k = r.querySelector(".kv-key").value.trim();
        const vRaw = r.querySelector(".kv-val").value.trim();
        if (!k) continue;
        // ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô number ‡∏ñ‡πâ‡∏≤‡∏î‡∏π‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç; ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô string ‡∏à‡∏£‡∏¥‡∏á‡πÜ (‡πÄ‡∏ä‡πà‡∏ô NAmes) ‡∏Å‡πá‡∏õ‡∏•‡πà‡∏≠‡∏¢‡πÑ‡∏ß‡πâ
        const num = Number(vRaw);
        fixed[k] = (vRaw !== "" && !Number.isNaN(num) && /^-?\d+(\.\d+)?$/.test(vRaw)) ? num : vRaw;
      }
      return fixed;
    }

    function showStatus(msg, ok=true) {
      const box = $("#status");
      box.innerHTML = `<div class="alert ${ok?'alert-success':'alert-danger'} mb-0">${msg}</div>`;
    }

    function renderCards(data) {
      const wrap = $("#cards");
      wrap.innerHTML = "";
      if (!data || !Array.isArray(data.cards)) return;

      data.cards.forEach((c, i) => {
        const priceUSD = c.predicted_price_usd ?? c.predicted_price ?? c.predicted_price_raw;
        const col = el("div","col-12 col-md-4");
        col.appendChild(el("div","card shadow-sm h-100",
          `<div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <h5 class="card-title mb-0">Card ${i+1}</h5>
              <span class="badge text-bg-primary">¬± Window</span>
            </div>
            <div class="mt-2">
              <div><strong>USD:</strong> $${fmt(priceUSD)}</div>
              ${c.predicted_price_thb !== undefined ? `<div><strong>THB:</strong> ‡∏ø${fmt(c.predicted_price_thb)}</div>` : ``}
              <div class="text-muted small mt-1">raw: ${c.predicted_price_raw !== undefined ? c.predicted_price_raw : '-'}</div>
            </div>
            <hr>
            <div class="small">
              <div class="text-muted mb-1">features</div>
              <pre class="bg-light p-2 rounded" style="max-height:220px; overflow:auto;">${JSON.stringify(c.features, null, 2)}</pre>
            </div>
          </div>`
        ));
        wrap.appendChild(col);
      });
    }

    function showRaw(obj) {
      $("#raw").textContent = JSON.stringify(obj, null, 2);
      $("#rawBox").classList.remove("d-none");
    }

    // ---------- Init ----------
    const kvList = $("#kvList");
    const addRow = () => kvList.appendChild(rowTemplate());
    $("#addRow").onclick = addRow;
    $("#prefill").onclick = () => {
      kvList.innerHTML = "";
      kvList.appendChild(rowTemplate("LotArea","9000"));
      kvList.appendChild(rowTemplate("OverallQual","6"));
      // ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà
      // kvList.appendChild(rowTemplate("Neighborhood","NAmes"));
    };
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ñ‡∏ß‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô 1 ‡πÅ‡∏ñ‡∏ß
    addRow();

    $("#toggleRaw").onclick = () => $("#rawBox").classList.toggle("d-none");

    // ---------- Call API ----------
    $("#go").onclick = async () => {
      const api = $("#apiUrl").value.trim() || "http://localhost:5000/api/three-cards";
      const pct = Number($("#pct").value || 0.15);
      const rate = Number($("#rate").value || 36);

      const payload = {
        fixed: collectFixed(),
        pct_window: pct,
        usd_to_thb: rate
      };

      try {
        const res = await fetch(api, {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify(payload)
        });
        const text = await res.text();
        let data;
        try { data = JSON.parse(text); } catch { data = { raw: text }; }

        if (!res.ok) {
          const msg = data?.detail || res.statusText || "Request failed";
          showStatus("‚ùå " + msg, false);
          showRaw(data);
          return;
        }

        showStatus("‚úÖ ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡πÑ‡∏î‡πâ " + (data.count ?? (data.cards?.length || 0)) + " cards");
        renderCards(data);
        showRaw(data);
      } catch (e) {
        showStatus("‚ùå Network error: " + e.message, false);
      }
    };

    $("#clear").onclick = () => {
      $("#cards").innerHTML = "";
      $("#status").innerHTML = "";
      $("#raw").textContent = "";
      $("#rawBox").classList.add("d-none");
    };
  </script>
</body>
</html>
